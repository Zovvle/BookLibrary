{% extends 'layout.html' %}

{% block title %} ä¹¦ç›®ä¿¡æ¯ {% endblock %}
{% block link %} 
	{% if book %}
	<a href="{{ url_for('reader')}}"> è¿”å› </a>
	{% endif %}
{% endblock %}

{% block body %}
	{% if error %}
	<div class=error>
	  <strong>Errror : </strong> {{error}}
	</div>
	{% endif %}
	
	{% with messages = get_flashed_messages() %}
	  {% if messages %}
	  <div class="success-message">
		{% for message in messages %}
		  <strong>æç¤ºï¼š</strong> {{ message }}
		{% endfor %}
	  </div>
	  {% endif %}
	{% endwith %}
	
	<h2> ä¹¦ç›®ä¿¡æ¯ </h2>
	{% if book %}
	<ul>
		<li> ISBNï¼š            	{{book.book_id}} </li>
		<li> ä¹¦åï¼š        		{{book.book_name}} </li>
		<li> ä½œè€…ï¼š        		{{book.author}} </li>	
		<li> å‡ºç‰ˆç¤¾ï¼š     	{{book.publish_com}} </li>
		<li> å‡ºç‰ˆæ—¥æœŸï¼š   	{{book.publish_date}} </li>
	</ul>
	{% else %}
	<p>å›¾ä¹¦ä¸å­˜åœ¨</p>
	{% endif %}
	
	<h2> å€Ÿé˜…çŠ¶æ€ </h2>
	
	{% if reader %}
		<!-- å·²å€Ÿå‡ºçš„æƒ…å†µ -->
		{% if reader.user_name == g.user %}
			<p><strong>ğŸ“š æ‚¨å·²å€Ÿé˜…æœ¬ä¹¦</strong></p>
			<ul>
				<li> å€Ÿé˜…è€…ï¼š {{ reader.user_name }}</li>
				<li> å€Ÿé˜…æ—¥æœŸï¼š {{ reader.date_borrow }}</li>
				<li> åº”è¿˜æ—¥æœŸï¼š {{ reader.date_return }}</li>
			</ul>
		{% else %}
			<p><strong>ğŸ“š æœ¬ä¹¦å·²è¢«å€Ÿé˜…</strong></p>
			<ul>
				<li> å€Ÿé˜…è€…ï¼š {{ reader.user_name }}</li>
				<li> å€Ÿé˜…æ—¥æœŸï¼š {{ reader.date_borrow }}</li>
				<li> åº”è¿˜æ—¥æœŸï¼š {{ reader.date_return }}</li>
			</ul>
			<p>æœ¬ä¹¦æš‚æ—¶ä¸å¯å€Ÿ</p>
		{% endif %}
	{% else %}
		<!-- å¯å€Ÿé˜…çš„æƒ…å†µ -->
		{% if book %}
			<p><strong>âœ… æœ¬ä¹¦å¯å€Ÿé˜…</strong></p>
			
			<!-- è·å–ç”¨æˆ·çš„å€Ÿé˜…æ•°é‡ -->
			{% set user_borrow_count = count[0] if count else 0 %}
			
			{% if user_borrow_count >= 3 %}
				<p class="error-text">âŒ æ‚¨å·²å€Ÿé˜… {{ user_borrow_count }} æœ¬ä¹¦ï¼Œå·²è¾¾ä¸Šé™ï¼ˆ3æœ¬ï¼‰</p>
			{% else %}
				<form action="{{ url_for('reader_book', id=book.book_id) }}" method="post" 
					  onsubmit="return confirmBorrow('{{ book.book_name|e }}', '{{ book.author|e }}')">
					<div class=actions>
						<input type="submit" value="å€Ÿé˜…æœ¬ä¹¦" class="btn-borrow">
					</div>
				</form>
				
				<!-- å€Ÿä¹¦ç¡®è®¤æç¤ºè„šæœ¬ -->
				<script>
				function confirmBorrow(bookName, author) {
					// è®¡ç®—30å¤©åçš„åº”è¿˜æ—¥æœŸ
					var today = new Date();
					var returnDate = new Date(today);
					returnDate.setDate(today.getDate() + 30);
					
					// æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
					var formatDate = function(date) {
						var year = date.getFullYear();
						var month = (date.getMonth() + 1).toString().padStart(2, '0');
						var day = date.getDate().toString().padStart(2, '0');
						return year + '-' + month + '-' + day;
					};
					
					var todayStr = formatDate(today);
					var returnDateStr = formatDate(returnDate);
					
					// åˆ›å»ºç¡®è®¤æ¶ˆæ¯
					var message = "ğŸ“š ç¡®è®¤å€Ÿé˜…\n\n" +
								"ä¹¦åï¼šã€Š" + bookName + "ã€‹\n" +
								"ä½œè€…ï¼š" + author + "\n\n" +
								"å€Ÿé˜…æ—¥æœŸï¼š" + todayStr + "\n" +
								"åº”è¿˜æ—¥æœŸï¼š" + returnDateStr + "\n" +
								"ï¼ˆå€ŸæœŸ30å¤©ï¼‰\n\n" +
								"ç¡®å®šè¦å€Ÿé˜…è¿™æœ¬ä¹¦å—ï¼Ÿ";
					
					// æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡»"ç¡®å®š"åˆ™è¿”å›trueï¼Œæäº¤è¡¨å•
					return confirm(message);
				}
				</script>
			{% endif %}
		{% else %}
			<p>å›¾ä¹¦ä¿¡æ¯ä¸å­˜åœ¨ï¼Œæ— æ³•å€Ÿé˜…</p>
		{% endif %}
	{% endif %}
	
	<style>
		.error {
			background-color: #ffebee;
			color: #c62828;
			padding: 10px;
			margin: 10px 0;
			border-radius: 4px;
			border-left: 4px solid #c62828;
		}
		
		.success-message {
			background-color: #e8f5e9;
			color: #2e7d32;
			padding: 10px;
			margin: 10px 0;
			border-radius: 4px;
			border-left: 4px solid #4caf50;
		}
		
		.error-text {
			color: #c62828;
			font-weight: bold;
			padding: 10px;
			background-color: #ffebee;
			border-radius: 4px;
		}
		
		.btn-borrow {
			background-color: #4CAF50;
			color: white;
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			font-weight: bold;
		}
		
		.btn-borrow:hover {
			background-color: #45a049;
		}
		
		h2 {
			color: #333;
			border-bottom: 2px solid #4CAF50;
			padding-bottom: 5px;
			margin-top: 20px;
		}
		
		ul {
			list-style-type: none;
			padding-left: 0;
		}
		
		li {
			padding: 8px 0;
			border-bottom: 1px solid #eee;
		}
		
		li:last-child {
			border-bottom: none;
		}
	</style>
{% endblock %}